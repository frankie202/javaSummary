# JVM

## 加载类的步骤

### 加载

### 链接

#### 验证

##### 字节码验证

##### 文件格式验证

##### 元数据验证

##### 符号链接验证

#### 准备

##### 类静态变量在此时申请内存，按照默认值初始化，初始值要到类构造器进行复制

#### 解析

### 初始化

### 使用

### 卸载

## JVM的运行时数据区

### 线程独享

#### java虚拟机栈

#### 本地方法栈

#### 程序计数器

### 线程共享

#### 堆

#### 方法区

##### jdk7以前使用永久代实现

##### jdk8以后使用元空间实现：使用操作系统的内存

## jvm优化

### -Xms：初始化堆大小

### -Xmx：最大堆大小

### -Xss：初始栈大小

### -Xmn：新生代大小

### -XX:SurvivorRatio：设置新生代中eden与from的比例

### -XX:MaxTenuringThreshold：到老年代的门限

## JMM

### java虚拟机视图定义一种java内存模型来屏蔽吊各种硬件与操作系统的见的访问差异，以实现让java在各种平台下都能一致内部才能访问的效果。

### 定义程序中共享变量的访问规则，包括实例字段、静态字段、构成数组对象的元素。

### 工作内存与主内存之间的一致性关系

### java内存间的交互操作

#### lock

#### unlock

#### read

#### load

#### use

#### assign：赋值

#### store

#### write

### volatile

#### 最轻量级的同步规则

#### 每次使用之前先要刷新

#### 只能保证可见性

#### 禁止指令重排序优化

#### 特性

##### 原子性

###### 由java内存模型直接保证原子性变量操作

##### 可见性

###### 当一个线程修改了共享变量的值，其他线程能够立即得知这个修改

##### 有序性

###### 本线程内观察所有的操作都是有序的；在一个线程内观察另一个线程，所有的操作都是无序的

####### 前半句是线程内变现为串行的语义；后半句指令重排序与工作内存与主内存同步延迟

### as-if-serial:不管怎么重排序，单线程程序的执行结果不能被改变。编译器、runtime和处理器都必须遵守as-if-serial语义

## 垃圾回收器

### 新生代

#### serial

#### ParNew

#### parallel Scavenge

### 老年代

#### serial old

#### CMS

##### 流程

###### 初始标记

###### 并发标记

###### 重新标记

###### 并发清除

#### parallel old

### G1

#### 流程

##### 初始标记

##### 并发标记

##### 最终标记

##### 筛选回收

#### 内存被划分为region，每个region的大小1-32M，如果一个对象超过一个region的一半，直接到老年代，一个对象超过一个region那么就到Humongous  region

## 判断对象是否可以被回收

### 引用计数

#### 最简单，存在循环引用问题

### 可达性分析

#### GCRoot的确定

##### 1、jvm虚拟机栈中持有的对象引用

##### 2、类静态属性持有的对象引用

##### 3、类常量持有的对象引用

##### 4、JNI持有的对象引用

##### 5、被锁持有的对象引用

##### 6、jvm内部使用的对象

##### 7、用于jvm监控的对象引用

##### 8、使用记忆集解决跨代引用问题

###### 字精度

###### 对象精度

###### 卡精度

####### 使用卡表进行记录，每个字节记录512字节

######## 伪共享

#### 确定对象是否可达，即确定对象是否存活

##### 使用三色标记

###### 黑色：已经访问过的对象，所有引用都已扫描过

###### 灰色：正在访问的对象，至少有一条引用还没有扫描过

###### 白色：没有扫描过的对象

##### 存在的问题

###### 对象消失

####### 赋值器插入一条或多条从黑色对象到白色节点的引用

####### 赋值器删除所有从灰色节点到白色节点的引用

###### 解决方法

####### 增量更新

######## CMS使用，打破第一条，记录所有黑色到白色对象的引用

####### 原始快照

######## G1使用，打破第二条，记录所有删除引用的灰色节点，重新扫描
